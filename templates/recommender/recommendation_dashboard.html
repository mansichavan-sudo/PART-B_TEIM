{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI CRM Recommendation Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        th { background-color: #007bff; color: white; cursor: pointer; }
        .filter-btn.active { background-color: #0d6efd; color: #fff; }
        .search-input { width: 300px; }
        #loadingSpinner { display: none; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">AI-Based CRM Recommendation Dashboard</h2>

    <!-- ðŸ”¹ Filter Buttons -->
    <div class="d-flex justify-content-center mb-3 flex-wrap">
        <button class="btn btn-outline-primary me-2 mb-2 filter-btn active" data-filter="All">All</button>
        <button class="btn btn-outline-primary me-2 mb-2 filter-btn" data-filter="Upsell">Upsell</button>
        <button class="btn btn-outline-primary me-2 mb-2 filter-btn" data-filter="Cross-Sell">Cross-Sell</button>
        <button class="btn btn-outline-primary me-2 mb-2 filter-btn" data-filter="Content-Based">Content-Based</button>
        <button class="btn btn-outline-primary me-2 mb-2 filter-btn" data-filter="Collaborative">Collaborative</button>
    </div>

    <!-- ðŸ”¹ Search Box -->
    <div class="text-center mb-3">
        <input type="text" id="searchInput" class="form-control search-input d-inline-block"
               placeholder="Search by customer or product...">
    </div>

    <!-- ðŸ”¹ Table -->
    <div class="card p-4">
        <table id="recommendationTable" class="table table-striped table-bordered align-middle">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Base Product</th>
                    <th>Recommended Product</th>
                    <th>Recommendation Type</th>
                    <th>Confidence Score</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for rec in recommendations %}
                <tr data-type="{{ rec.recommendation_type }}">
                    <td>{{ rec.customer_name }}</td>
                    <td>{{ rec.base_product }}</td>
                    <td>{{ rec.recommended_product }}</td>
                    <td>{{ rec.recommendation_type }}</td>
                    <td>{{ rec.confidence_score }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="openSendMessageModal('{{ rec.customer_name }}', '{{ rec.base_product }}', '{{ rec.recommended_product }}', '{{ rec.recommendation_type }}')">
                            Send Message
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">No recommendation data found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ðŸ’¬ Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sendMessageLabel">Send Message to Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <button class="btn btn-sm btn-outline-success" id="autoSuggestBtn">âœ¨ Auto Suggest</button>
          <div id="loadingSpinner" class="spinner-border text-primary spinner-border-sm" role="status"></div>
        </div>
        <textarea id="messageContent" class="form-control" rows="4" placeholder="Write your message..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="sendMessageBtn">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
let selectedCustomer = null, baseProduct = null, recommendedProduct = null, recType = null;

function openSendMessageModal(customer, base, recommended, type) {
    selectedCustomer = customer;
    baseProduct = base;
    recommendedProduct = recommended;
    recType = type;

    document.getElementById("messageContent").value =
        `Hello ${customer}, we recommend ${recommended} along with your ${base}.`;

    new bootstrap.Modal(document.getElementById('sendMessageModal')).show();
}

// âœ¨ Auto Suggest Message
document.getElementById("autoSuggestBtn").addEventListener("click", async function() {
    const spinner = document.getElementById("loadingSpinner");
    spinner.style.display = "inline-block";

    try {
        const response = await fetch("/api/generate-message/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                customer_name: selectedCustomer,
                base_product: baseProduct,
                recommended_product: recommendedProduct,
                recommendation_type: recType
            })
        });

        const data = await response.json();
        document.getElementById("messageContent").value = data.message || "No suggestion available.";
    } catch (error) {
        alert("Error generating message.");
    } finally {
        spinner.style.display = "none";
    }
});

// ðŸ“¨ Send Message
document.getElementById("sendMessageBtn").addEventListener("click", async function() {
    const message = document.getElementById("messageContent").value;
    if (!message.trim()) return alert("Please enter a message.");

    try {
        const response = await fetch("/api/send-message/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                customer_name: selectedCustomer,
                message: message
            })
        });

        const result = await response.json();
        alert(result.message || "Message sent successfully!");
    } catch (error) {
        alert("Failed to send message.");
    }
});

// ðŸ”¹ Filter Functionality
function filterTable(type) {
    const rows = document.querySelectorAll("#recommendationTable tbody tr");
    rows.forEach(row => {
        const recType = row.children[3].innerText.trim();
        row.style.display = (type === "All" || recType === type) ? "" : "none";
    });

    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    document.querySelector(`.filter-btn[data-filter='${type}']`).classList.add("active");
}

// ðŸ”¹ Search Functionality
document.getElementById("searchInput").addEventListener("input", function() {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll("#recommendationTable tbody tr");
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(searchValue) ? "" : "none";
    });
});

// ðŸ”¹ Attach Filter Button Click Events
document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const type = this.getAttribute("data-filter");
        filterTable(type);
    });
});

// Default view
filterTable("All");
</script>

</body>
</html>
